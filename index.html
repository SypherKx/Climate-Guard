<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plant on Floor AR (Fixed)</title>

    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <style>
      html, body { margin: 0; height: 100%; overflow: hidden; }
      #overlay {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 10;
      }
      button {
        padding: 12px 18px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        background: green;
        color: white;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div id="overlay">
      <button id="startAR">Start AR ðŸŒ¿</button>
      <button id="placeButton" style="display:none;">Place Plant ðŸŒ±</button>
    </div>

    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      renderer="colorManagement: true; physicallyCorrectLights;"
      webxr="optionalFeatures: hit-test, dom-overlay, local-floor; overlayElement: #overlay;"
      device-orientation-permission-ui="enabled: true;"
    >
      <a-entity light="type: directional; intensity: 1;" position="1 3 2"></a-entity>
      <a-entity light="type: ambient; intensity: 0.6"></a-entity>

      <!-- Reticle -->
      <a-entity
        id="reticle"
        visible="false"
        geometry="primitive: ring; radiusInner: 0.04; radiusOuter: 0.05;"
        material="color: lime; shader: flat;"
        rotation="-90 0 0"
      ></a-entity>

      <!-- Plant Model -->
      <a-entity
        id="plant"
        visible="false"
        scale="0.5 0.5 0.5"
        gltf-model="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Avocado/glTF-Binary/Avocado.glb"
      ></a-entity>

      <a-camera position="0 1.6 0"></a-camera>
    </a-scene>

    <script>
      const startBtn = document.getElementById("startAR");
      const placeBtn = document.getElementById("placeButton");
      const scene = document.querySelector("a-scene");
      const reticle = document.getElementById("reticle");
      const plant = document.getElementById("plant");

      let xrHitTestSource = null;
      let xrSession = null;
      let xrRefSpace = null;

      startBtn.onclick = async () => {
        if (!navigator.xr) {
          alert("WebXR not supported on this browser.");
          return;
        }

        const supported = await navigator.xr.isSessionSupported("immersive-ar");
        if (!supported) {
          alert("AR not supported on this device.");
          return;
        }

        xrSession = await navigator.xr.requestSession("immersive-ar", {
          requiredFeatures: ["hit-test", "local-floor"],
          optionalFeatures: ["dom-overlay"],
          domOverlay: { root: document.body },
        });

        scene.renderer.xr.setSession(xrSession);

        xrRefSpace = await xrSession.requestReferenceSpace("local-floor");
        const viewerSpace = await xrSession.requestReferenceSpace("viewer");
        xrHitTestSource = await xrSession.requestHitTestSource({ space: viewerSpace });

        xrSession.addEventListener("end", () => {
          xrHitTestSource = null;
          xrSession = null;
          startBtn.style.display = "inline-block";
          placeBtn.style.display = "none";
        });

        startBtn.style.display = "none";
        placeBtn.style.display = "inline-block";

        xrSession.requestAnimationFrame(onXRFrame);
      };

      function onXRFrame(time, frame) {
        if (!xrSession) return;
        const session = xrSession;
        session.requestAnimationFrame(onXRFrame);

        const hitTestResults = frame.getHitTestResults(xrHitTestSource);
        if (hitTestResults.length > 0) {
          const hitPose = hitTestResults[0].getPose(xrRefSpace);
          if (!hitPose) return;

          reticle.visible = true;
          reticle.object3D.position.set(
            hitPose.transform.position.x,
            hitPose.transform.position.y,
            hitPose.transform.position.z
          );
          reticle.object3D.quaternion.set(
            hitPose.transform.orientation.x,
            hitPose.transform.orientation.y,
            hitPose.transform.orientation.z,
            hitPose.transform.orientation.w
          );
        } else {
          reticle.visible = false;
        }
      }

      placeBtn.onclick = () => {
        if (!reticle.visible) {
          alert("Move your phone to find a surface first!");
          return;
        }
        const pos = reticle.getAttribute("position");
        plant.setAttribute("position", pos);
        plant.setAttribute("visible", "true");
      };
    </script>
  </body>
  <!---->
</html>